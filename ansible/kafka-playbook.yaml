- hosts: brokers
  become: yes

  pre_tasks:
    - name: Upgrade
      apt:
        update_cache: yes
        install_recommends: yes

    - name: Install Docker
      apt:
        pkg:
          - ca-certificates
          - curl
          - gnupg
 
    - name: Set up apt repository
      shell: |
        sudo apt-get update
        sudo apt-get install ca-certificates curl
        sudo install -m 0755 -d /etc/apt/keyrings
        sudo curl -fsSL https://download.docker.com/linux/ubuntu/gpg -o /etc/apt/keyrings/docker.asc
        sudo chmod a+r /etc/apt/keyrings/docker.asc

        # Add the repository to Apt sources:
        echo \
          "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.asc] https://download.docker.com/linux/ubuntu \
          $(. /etc/os-release && echo "${UBUNTU_CODENAME:-$VERSION_CODENAME}") stable" | \
            sudo tee /etc/apt/sources.list.d/docker.list > /dev/null
          sudo apt-get update

    - name: Install docker packages
      apt:
        pkg:
          - docker-ce
          - docker-ce-cli
          - containerd.io
          - docker-buildx-plugin
          - docker-compose-plugin

    - name: Run docker hello world
      shell: |
        sudo service docker start
        sudo docker run hello-world

    - name: Install confluent cli apt public key
      shell: |
        sudo mkdir -p /etc/apt/keyrings
        curl https://packages.confluent.io/confluent-cli/deb/archive.key | sudo gpg --dearmor -o /etc/apt/keyrings/confluent-cli.gpg
        sudo chmod go+r /etc/apt/keyrings/confluent-cli.gpg
        echo "deb [arch=amd64 signed-by=/etc/apt/keyrings/confluent-cli.gpg] https://packages.confluent.io/confluent-cli/deb stable main" | sudo tee /etc/apt/sources.list.d/confluent-cli.list >/dev/null
        sudo apt-get update

    - name: Install confluent cli
      apt:
        pkg:
          - confluent-cli=3.48.0

    - name: Test confluent isntall
      shell: sudo confluent version

    - name: Start kafka broker
      shell: |
        sudo confluent local kafka start
        sudo confluent local kafka topic create purchases
